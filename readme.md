# ESP32 麦克风阵列数据采集系统

## 开发环境

- ESP-IDF 5.2.1
- 目标芯片: ESP32-S3
- 语言: C

## 硬件配置

- **麦克风**: ADAU7118 (8通道PDM麦克风接口)
- **存储**: SD卡 (通过SDMMC接口)
- **时钟**: TDM接口配置为96kHz采样率, 16位宽
- **内存**: 使用PSRAM (8线模式, 80MHz)

## sdkconfig 修改

相比默认配置，主要修改如下:

- **PSRAM配置**:
  - `CONFIG_SPIRAM=y` - 启用PSRAM支持
  - `CONFIG_SPIRAM_MODE_OCT=y` - 使用8线模式
  - `CONFIG_SPIRAM_SPEED_80M=y` - PSRAM时钟频率80MHz

- **闪存配置**:
  - `CONFIG_ESPTOOLPY_FLASHSIZE_16MB=y` - 使用16MB闪存

- **系统配置**:
   - CPU频率设置为240MHz
   - FreeRTOS 的调度频率为1000Hz

## 程序功能介绍

该项目是一个基于ESP32-S3的多通道音频采集系统，主要用于8通道麦克风阵列数据的采集和存储。

### 主要功能

1. **多通道音频采集**:
   - 通过ADAU7118芯片采集8通道音频数据
   - 采样率96kHz，16位量化
   - 使用TDM接口传输数据

2. **数据存储**:
   - 将采集的音频数据实时保存到SD卡
   - 自动生成文件名，避免覆盖已有数据
   - 使用多缓冲区机制确保数据无丢失

3. **交互控制**:
   - 提供UART命令行界面 (REPL)
   - 支持`startaudio`和`stopaudio`命令控制录音
   - 通过串口提供状态反馈

### 系统架构

- **双任务设计**:
  - `audio_capture_task`: 负责从TDM接口读取数据到缓冲区
  - `file_save_task`: 负责将缓冲区数据写入SD卡

- **多级缓冲**:
  - 使用6个大小为32KB的环形缓冲区，请确保开发板RAM足够大
  - 采用互斥锁保护缓冲区访问
  - 实现生产者-消费者模型确保数据安全传输

- **硬件初始化**:
  - 自动初始化SD卡、ADAU7118和TDM接口
  - 错误检测和异常处理机制

### 使用方法

1. 通过串口连接到ESP32-S3 (默认波特率115200)
2. 在提示符`esp32>`输入命令:
   - `startaudio` - 开始录音
   - `stopaudio` - 停止录音
3. 录音文件以"AudioX.bin"格式保存在SD卡根目录下 (X为自动递增的数字)

### 注意事项

- 确保SD卡已正确格式化 (FAT格式)
- ADAU7118需要正确连接到指定的SDIO,I2C和TDM引脚,可以在SD_MMC,hardwareInit.h与ADAU7118.h中修改
- 使用高速SD卡以确保不会因写入速度导致数据丢失